#if LV_BUILD_TEST
#include "../lvgl.h"

#include "unity/unity.h"


const char * read_exp =
    "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam sed maximus orci. Morbi massa nisi, varius eu convallis ac, venenatis at metus. In in nibh id urna pretium feugiat vitae eu libero. Ut eget fringilla eros. Nunc ullamcorper lectus mauris, vel rhoncus velit volutpat et. Phasellus sed molestie massa. Maecenas quis dui sollicitudin, vulputate nunc ut, dictum quam. Nam a congue lorem. Nulla non facilisis sapien. Ut luctus nulla nibh, sed finibus urna porta non. Duis aliquet augue id urna euismod auctor. Integer pellentesque vulputate enim non mattis. Donec finibus mattis dolor, et feugiat nisi pharetra porta. Mauris ullamcorper cursus magna. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.";


static void read_range(lv_fs_file_t * f, uint32_t from, uint32_t to);

static void read_random_drv(char drv_letter);

void setUp(void)
{
    /* Function run before every test */
}

void tearDown(void)
{
    /* Function run after every test */
}
#include <stdio.h>
#include <errno.h>
#include <unistd.h>

void test_read(void)
{
    lv_fs_res_t res;

    char cur[512];
    getcwd(cur, 512);
    errno = 0;
    void * a = fopen("src/test_files/readtest.txt", "rd");
    printf("%s, %d, %p\n", cur, errno, a);
    fclose(a);

    /*'A' has cache*/
    lv_fs_file_t fa;
    res = lv_fs_open(&fa, "A:src/test_files/readtest.txt", LV_FS_MODE_RD);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    /*'B' has no cache*/
    lv_fs_file_t fb;
    res = lv_fs_open(&fb, "B:src/test_files/readtest.txt", LV_FS_MODE_RD);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    /*Use an odd size to make sure it's not aligned with the drivier's'cache size*/
    uint8_t buf[79];
    uint32_t cnt = 0;
    uint32_t br = 1;
    while(br) {
        res = lv_fs_read(&fa, buf, sizeof(buf), &br);
        TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);
        TEST_ASSERT_TRUE(memcmp(buf, read_exp + cnt, br) == 0);

        res = lv_fs_read(&fb, buf, sizeof(buf), &br);
        TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);
        TEST_ASSERT_TRUE(memcmp(buf, read_exp + cnt, br) == 0);
        cnt += br;
    }

    lv_fs_close(&fa);
    lv_fs_close(&fb);
}

void test_read_random(void)
{
    read_random_drv('A');
    read_random_drv('B');
}

/**
 * Read bytes from the `from` index to the `to index`
 * Assume that file `f` has 256 byte of content 0..255
 */
static void read_range(lv_fs_file_t * f, uint32_t from, uint32_t to)
{
    lv_fs_seek(f, from, LV_FS_SEEK_SET);

    uint32_t len = to - from + 1;
    uint8_t buf_rd[256];
    uint32_t br;
    lv_fs_read(f, buf_rd, len, &br);

    TEST_ASSERT_EQUAL(br, len);

    uint32_t i;
    for(i = 0; i < len; i++) {
        TEST_ASSERT_EQUAL(buf_rd[i], from + i);
    }
}

static void read_random_drv(char drv_letter)
{
    /*Hack to force a small cache size*/
    lv_fs_drv_t * drv = lv_fs_get_drv(drv_letter);
    drv->cache_size = 32;

    char fn[64];
    lv_snprintf(fn, sizeof(fn), "%c:fs_read_random.bin", drv_letter);

    lv_fs_res_t res;
    lv_fs_file_t f;
    res = lv_fs_open(&f, fn, LV_FS_MODE_WR);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    uint8_t buf256[256];
    uint32_t i;
    for(i = 0; i < 256; i++) buf256[i] = i;

    res = lv_fs_write(&f, buf256, 256, NULL);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    res = lv_fs_close(&f);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    res = lv_fs_open(&f, fn, LV_FS_MODE_RD);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);

    // *INDENT-OFF*
    static const uint8_t ranges[1000][2] = {
            {74, 109}, {16, 84}, {105, 172}, {70, 135}, {70, 143}, {20, 85}, {123, 230}, {1, 6}, {105, 204}, {106, 113}, {73, 154}, {31, 131}, {122, 125}, {18, 74}, {123, 238}, {2, 111}, {72, 110}, {122, 138}, {118, 166}, {110, 207}, {106, 180}, {80, 164}, {105, 171}, {102, 212}, {110, 118}, {40, 107}, {38, 122}, {68, 147}, {51, 163}, {79, 195}, {27, 126}, {76, 90}, {110, 124}, {109, 195}, {14, 47}, {97, 192}, {122, 188}, {75, 153}, {7, 44}, {11, 56}, {69, 181}, {75, 139}, {34, 157}, {16, 94}, {97, 158}, {127, 175}, {87, 210}, {66, 132}, {49, 159}, {74, 199}, {60, 176}, {31, 112}, {52, 150}, {50, 88}, {61, 85}, {56, 127}, {72, 149}, {113, 227}, {111, 190}, {15, 73}, {23, 71}, {8, 43}, {28, 145}, {68, 115}, {84, 162}, {108, 193}, {26, 96}, {8, 133}, {123, 229}, {114, 217}, {17, 36}, {101, 156}, {120, 181}, {48, 159}, {0, 8}, {22, 129}, {101, 221}, {113, 229}, {114, 180}, {75, 128}, {83, 144}, {120, 169}, {128, 204}, {88, 108}, {19, 55}, {33, 33}, {86, 98}, {3, 26}, {72, 145}, {87, 147}, {0, 62}, {16, 52}, {42, 167}, {71, 176}, {119, 188}, {27, 78}, {86, 94}, {23, 41}, {52, 107}, {3, 100}, {121, 153}, {64, 110}, {92, 94}, {107, 203}, {72, 175}, {72, 75}, {90, 108}, {62, 84}, {29, 72}, {27, 137}, {111, 137}, {116, 176}, {57, 106}, {48, 169}, {6, 60}, {127, 250}, {37, 50}, {48, 100}, {3, 79}, {11, 28}, {70, 132}, {37, 137}, {69, 139}, {75, 160}, {60, 156}, {29, 140}, {103, 224}, {82, 88}, {76, 110}, {115, 200}, {37, 54}, {26, 118}, {56, 90}, {73, 94}, {3, 119}, {76, 186}, {64, 97}, {62, 129}, {97, 136}, {75, 93}, {83, 176}, {81, 198}, {5, 58}, {26, 82}, {16, 89}, {123, 127}, {67, 158}, {59, 114}, {70, 74}, {105, 162}, {94, 130}, {18, 73}, {68, 154}, {110, 130}, {93, 202}, {29, 71}, {10, 110}, {29, 48}, {90, 94}, {31, 118}, {102, 179}, {90, 114}, {76, 194}, {41, 142}, {40, 156}, {36, 97}, {119, 149},
            {81, 127}, {37, 76}, {74, 191}, {46, 67}, {35, 37}, {51, 160}, {85, 173}, {110, 206}, {108, 222}, {98, 202}, {118, 118}, {123, 233}, {77, 196}, {48, 102}, {20, 133}, {110, 163}, {93, 191}, {56, 101}, {109, 235}, {33, 83}, {8, 113}, {99, 125}, {2, 21}, {50, 154}, {104, 154}, {68, 174}, {36, 118}, {99, 191}, {72, 118}, {86, 171}, {72, 112}, {102, 146}, {48, 120}, {14, 74}, {41, 69}, {99, 198}, {0, 65}, {1, 89}, {97, 184}, {121, 190}, {128, 202}, {104, 140}, {10, 53}, {122, 159}, {122, 178}, {112, 121}, {14, 58}, {34, 76}, {66, 135}, {27, 93}, {73, 85}, {13, 36}, {124, 177}, {78, 105}, {10, 55}, {39, 73}, {90, 137}, {59, 129}, {119, 124}, {103, 195}, {41, 149}, {11, 124}, {46, 89}, {125, 175}, {20, 94}, {99, 136}, {91, 157}, {74, 137}, {4, 9}, {82, 98}, {29, 150}, {106, 205}, {21, 62}, {26, 122}, {80, 152}, {20, 115}, {56, 169}, {8, 63}, {115, 121}, {27, 110}, {128, 250}, {58, 70}, {0, 32}, {30, 154}, {83, 210}, {115, 192}, {85, 176}, {21, 116}, {69, 79}, {58, 101}, {19, 136}, {32, 93}, {37, 98}, {25, 51}, {31, 145}, {49, 160}, {95, 195}, {120, 138}, {4, 12}, {3, 65}, {6, 84}, {17, 43}, {10, 105}, {85, 193}, {41, 140}, {118, 209}, {127, 231}, {96, 140}, {16, 53}, {97, 212}, {65, 111}, {86, 200}, {55, 158}, {30, 46}, {48, 104}, {1, 117}, {80, 135}, {73, 90}, {90, 167}, {13, 74}, {114, 130}, {69, 196}, {111, 160}, {7, 70}, {51, 102}, {15, 112}, {2, 81}, {43, 114}, {9, 79}, {110, 146}, {71, 89}, {93, 139}, {76, 99}, {54, 171}, {110, 224}, {9, 127}, {56, 70}, {17, 64}, {83, 196}, {41, 130}, {64, 73}, {21, 83}, {92, 203}, {22, 42}, {102, 141}, {59, 108}, {104, 165}, {121, 223}, {18, 29}, {95, 107}, {90, 126}, {24, 53}, {4, 83}, {19, 53}, {47, 156}, {69, 126}, {28, 75}, {82, 143}, {3, 67}, {69, 112}, {2, 15}, {55, 159}, {92, 103}, {70, 187}, {36, 127}, {100, 123}, {30, 106}, {87, 168},
            {111, 124}, {50, 132}, {93, 122}, {41, 129}, {83, 178}, {19, 130}, {80, 171}, {20, 126}, {23, 39}, {12, 37}, {107, 117}, {26, 110}, {23, 135}, {30, 34}, {49, 88}, {55, 106}, {25, 118}, {78, 190}, {95, 114}, {34, 118}, {121, 154}, {57, 106}, {111, 182}, {124, 158}, {118, 135}, {30, 113}, {54, 153}, {49, 135}, {59, 133}, {66, 92}, {123, 207}, {6, 76}, {113, 237}, {97, 173}, {114, 199}, {97, 151}, {26, 26}, {52, 97}, {87, 180}, {111, 231}, {42, 62}, {97, 156}, {51, 136}, {52, 63}, {48, 143}, {125, 249}, {71, 168}, {105, 119}, {4, 93}, {124, 148}, {100, 190}, {114, 186}, {69, 97}, {7, 97}, {50, 161}, {69, 95}, {90, 196}, {95, 143}, {121, 186}, {104, 201}, {30, 92}, {124, 205}, {58, 140}, {42, 87}, {58, 115}, {90, 103}, {34, 146}, {66, 139}, {103, 181}, {63, 188}, {11, 53}, {61, 105}, {76, 179}, {34, 36}, {47, 158}, {34, 121}, {88, 189}, {24, 87}, {36, 76}, {125, 251}, {66, 192}, {8, 127}, {34, 59}, {62, 167}, {19, 62}, {115, 213}, {75, 137}, {106, 135}, {75, 158}, {26, 134}, {110, 125}, {111, 172}, {42, 149}, {38, 108}, {115, 224}, {20, 134}, {111, 120}, {111, 184}, {37, 111}, {112, 233}, {126, 142}, {75, 158}, {41, 145}, {34, 121}, {18, 122}, {120, 209}, {28, 100}, {51, 134}, {45, 98}, {114, 157}, {93, 143}, {31, 38}, {11, 21}, {89, 95}, {70, 120}, {68, 189}, {41, 53}, {111, 140}, {95, 120}, {73, 191}, {61, 81}, {32, 124}, {58, 112}, {25, 109}, {122, 245}, {96, 154}, {51, 167}, {58, 85}, {94, 175}, {86, 110}, {21, 143}, {12, 87}, {10, 12}, {58, 144}, {125, 148}, {110, 145}, {87, 163}, {99, 188}, {32, 41}, {59, 135}, {61, 161}, {96, 152}, {25, 131}, {70, 128}, {39, 132}, {31, 157}, {79, 95}, {81, 97}, {44, 114}, {4, 96}, {128, 222}, {27, 131}, {71, 83}, {61, 94}, {57, 178}, {91, 170}, {45, 134}, {31, 76}, {50, 66}, {102, 156}, {7, 50}, {114, 131}, {78, 179}, {77, 133}, {45, 161},
            {72, 140}, {87, 119}, {44, 50}, {43, 56}, {78, 147}, {58, 174}, {70, 155}, {91, 138}, {89, 114}, {102, 199}, {113, 181}, {103, 223}, {119, 182}, {81, 152}, {30, 37}, {98, 199}, {34, 119}, {96, 206}, {74, 150}, {86, 207}, {127, 142}, {77, 177}, {49, 161}, {106, 140}, {33, 139}, {25, 48}, {61, 162}, {51, 87}, {122, 187}, {91, 202}, {97, 162}, {14, 102}, {80, 114}, {117, 202}, {123, 151}, {82, 116}, {31, 87}, {120, 175}, {21, 143}, {127, 211}, {112, 202}, {8, 54}, {80, 86}, {90, 216}, {111, 198}, {124, 213}, {31, 52}, {95, 147}, {51, 130}, {72, 96}, {85, 203}, {36, 65}, {75, 161}, {44, 115}, {61, 123}, {90, 211}, {39, 47}, {72, 134}, {75, 139}, {86, 87}, {124, 185}, {57, 87}, {1, 44}, {30, 49}, {105, 158}, {116, 172}, {58, 94}, {31, 138}, {65, 123}, {58, 96}, {80, 86}, {25, 138}, {6, 82}, {71, 155}, {102, 222}, {77, 173}, {126, 138}, {75, 162}, {77, 149}, {44, 98}, {92, 120}, {111, 193}, {112, 226}, {27, 64}, {100, 114}, {122, 165}, {83, 208}, {12, 138}, {54, 177}, {46, 109}, {28, 95}, {18, 40}, {113, 177}, {39, 132}, {110, 130}, {52, 165}, {39, 96}, {115, 135}, {101, 170}, {83, 161}, {75, 121}, {11, 44}, {88, 206}, {5, 66}, {88, 122}, {39, 112}, {99, 206}, {78, 79}, {109, 130}, {7, 91}, {3, 117}, {96, 135}, {54, 97}, {45, 130}, {7, 63}, {65, 174}, {116, 142}, {42, 44}, {80, 207}, {89, 178}, {28, 110}, {100, 177}, {53, 127}, {110, 159}, {102, 151}, {99, 197}, {89, 163}, {3, 104}, {125, 200}, {103, 227}, {115, 190}, {122, 141}, {128, 255}, {14, 100}, {23, 120}, {13, 119}, {31, 101}, {94, 157}, {10, 137}, {88, 214}, {2, 48}, {113, 134}, {10, 114}, {85, 164}, {3, 62}, {87, 207}, {87, 180}, {13, 79}, {99, 177}, {6, 30}, {62, 78}, {119, 136}, {23, 129}, {53, 82}, {55, 64}, {8, 93}, {101, 193}, {110, 231}, {9, 128}, {93, 119}, {23, 26}, {121, 189}, {2, 39}, {27, 53}, {111, 211}, {49, 100},
            {92, 200}, {30, 89}, {34, 85}, {38, 126}, {6, 114}, {122, 145}, {48, 148}, {64, 129}, {3, 115}, {77, 124}, {82, 201}, {85, 210}, {56, 119}, {128, 209}, {87, 101}, {36, 56}, {97, 139}, {85, 149}, {6, 14}, {39, 43}, {69, 91}, {11, 87}, {91, 128}, {81, 103}, {86, 156}, {15, 80}, {2, 99}, {15, 36}, {124, 166}, {108, 136}, {107, 192}, {104, 227}, {7, 50}, {30, 94}, {39, 96}, {126, 173}, {121, 183}, {84, 119}, {121, 233}, {48, 58}, {121, 135}, {95, 211}, {97, 180}, {3, 59}, {38, 124}, {113, 164}, {34, 96}, {9, 29}, {29, 72}, {100, 128}, {104, 224}, {60, 187}, {39, 133}, {27, 105}, {28, 142}, {97, 150}, {68, 151}, {116, 171}, {1, 105}, {83, 123}, {54, 171}, {70, 142}, {118, 150}, {32, 85}, {124, 138}, {98, 165}, {13, 29}, {40, 149}, {59, 111}, {112, 191}, {67, 118}, {84, 211}, {108, 141}, {118, 153}, {21, 120}, {26, 29}, {85, 133}, {119, 162}, {12, 121}, {50, 151}, {64, 126}, {13, 92}, {19, 39}, {69, 189}, {66, 68}, {122, 172}, {4, 88}, {127, 220}, {128, 164}, {116, 206}, {50, 75}, {38, 88}, {113, 137}, {60, 132}, {16, 24}, {61, 63}, {20, 25}, {12, 24}, {110, 112}, {49, 105}, {29, 114}, {13, 66}, {87, 181}, {39, 104}, {89, 132}, {106, 194}, {81, 132}, {20, 102}, {119, 237}, {59, 103}, {24, 107}, {96, 181}, {87, 195}, {79, 87}, {17, 93}, {2, 98}, {89, 137}, {120, 178}, {81, 206}, {100, 131}, {39, 131}, {101, 189}, {38, 127}, {100, 148}, {62, 62}, {18, 54}, {29, 120}, {69, 96}, {112, 155}, {46, 74}, {88, 111}, {84, 186}, {47, 105}, {96, 187}, {84, 89}, {0, 43}, {114, 121}, {57, 77}, {66, 177}, {78, 114}, {80, 138}, {0, 97}, {13, 18}, {17, 65}, {8, 13}, {61, 168}, {34, 96}, {119, 242}, {99, 189}, {4, 99}, {114, 230}, {104, 148}, {60, 109}, {106, 215}, {113, 190}, {74, 80}, {16, 77}, {17, 77}, {87, 97}, {98, 180}, {116, 152}, {49, 138}, {68, 192}, {110, 223}, {115, 157}, {34, 52}, {76, 125},
            {62, 140}, {17, 39}, {71, 142}, {54, 72}, {80, 152}, {38, 47}, {82, 94}, {116, 196}, {122, 172}, {14, 54}, {3, 123}, {52, 118}, {126, 221}, {117, 143}, {88, 140}, {61, 163}, {14, 35}, {30, 35}, {61, 81}, {116, 218}, {19, 130}, {114, 169}, {54, 131}, {81, 101}, {61, 154}, {115, 238}, {70, 144}, {89, 201}, {64, 157}, {82, 209}, {121, 196}, {117, 158}, {59, 82}, {89, 131}, {18, 82}, {56, 96}, {11, 27}, {113, 180}, {35, 136}, {113, 213}, {36, 93}, {95, 159}, {54, 83}, {2, 80}, {74, 176}, {8, 11}, {33, 50}, {19, 144}, {34, 114}, {107, 166}, {54, 180}, {8, 73}, {68, 77}, {98, 179}, {5, 41}, {52, 74}, {3, 78}, {19, 123}, {109, 184}, {17, 95}, {97, 106}, {76, 175}, {73, 188}, {15, 43}, {111, 113}, {9, 70}, {52, 171}, {10, 116}, {8, 121}, {112, 126}, {119, 141}, {116, 225}, {49, 87}, {87, 89}, {83, 183}, {24, 112}, {79, 206}, {22, 28}, {103, 193}, {106, 142}, {92, 136}, {17, 29}, {19, 61}, {81, 153}, {54, 163}, {61, 137}, {0, 59}, {76, 84}, {20, 77}, {37, 124}, {23, 111}, {39, 118}, {54, 74}, {127, 203}, {76, 188}, {11, 82}, {30, 69}, {56, 124}, {25, 140}, {14, 40}, {127, 223}, {51, 95}, {75, 104}, {18, 111}, {8, 99}, {76, 78}, {80, 158}, {1, 127}, {100, 122}, {101, 110}, {97, 139}, {28, 35}, {120, 142}, {3, 7}, {99, 140}, {83, 190}, {95, 132}, {94, 188}, {53, 69}, {9, 54}, {65, 161}, {102, 198}, {87, 199}, {48, 51}, {7, 84}, {46, 99}, {106, 111}, {40, 142}, {123, 163}, {65, 176}, {31, 136}, {119, 124}, {4, 10}, {125, 248}, {52, 93}, {30, 80}, {25, 60}, {18, 129}, {29, 72}, {55, 179}, {99, 102}, {100, 213}, {53, 76}, {86, 122}, {71, 194}, {14, 61}, {26, 136}, {98, 103}, {65, 97}, {64, 103}, {10, 121}, {113, 235}, {125, 216}, {120, 196}, {81, 125}, {37, 57}, {123, 153}, {80, 191}, {113, 201}, {27, 98}, {68, 98}, {109, 151}, {80, 197}, {72, 169}, {27, 45}, {116, 143}, {93, 185},
    };
    // *INDENT-ON*

    for(i = 0; i < 1000; i++) {
        read_range(&f, ranges[i][0], ranges[i][1]);
    }

    res = lv_fs_close(&f);
    TEST_ASSERT_EQUAL(LV_FS_RES_OK, res);
}

#endif
